```{r}
library(dplyr)
library(magrittr)
```

```{r load_all_data}

#batch_id <- args[1] #"2016_04_01_a549_48hr_batch1"
batch_id <- "2016_04_01_a549_48hr_batch1"

metadata_dir <- paste("../..", "metadata", batch_id, sep = "/")

backend_dir <- paste("../..", "backend", batch_id, sep = "/")

per_well_csv <- 
  tibble::data_frame(flist = 
                       list.files(backend_dir, 
                                  pattern = "*augmented.csv", 
                                  recursive = T, full.names = T)
  )

per_well_csv %<>% 
  rowwise() %>%
  mutate(Assay_Plate_Barcode = 
           stringr::str_split(basename(flist), "_")[[1]][1]
         ) %>%
  ungroup()

per_well_csv %<>% inner_join(
  readr::read_csv(paste(metadata_dir, "barcode_platemap.csv", sep = "/")) %>%
    select(Compound_Plate_Map_Name, Assay_Plate_Barcode)
)

per_well_csv %>% 
  count(Compound_Plate_Map_Name) %>%
  knitr::kable()

df <- lapply(per_well_csv$flist %>% normalizePath(), readr::read_csv) %>% bind_rows()

df %<>%
  mutate(Metadata_broad_sample = ifelse(is.na(Metadata_broad_sample), "control", "trt")) %>%
  mutate(Metadata_mg_per_ml = ifelse(Metadata_broad_sample =="control", 0, Metadata_mg_per_ml)) %>%
  mutate(Metadata_mmoles_per_liter = ifelse(Metadata_broad_sample =="control", 0, Metadata_mmoles_per_liter)) 
  
feature_cols <-
  colnames(df) %>%
  stringr::str_subset("^Nuclei_|^Cells_|^Cytoplasm_")

metadata_cols <-
  colnames(df) %>%
  stringr::str_subset("^Metadata_")

df %>% 
  count(Metadata_Compound_Plate_Map_Name, Metadata_Plate) %>%
  knitr::kable()
```


```{r}
selected <-
  cytominr::select(
    population = df,
    variables = feature_cols,
    sample = df,
    operation = "variance_threshold"
  ) %>%
  dplyr::collect()

feature_cols <-
  colnames(selected) %>%
  stringr::str_subset("^Nuclei_|^Cells_|^Cytoplasm_")
```

```{r}
selected <-
  cytominr::select(
    population = selected,
    variables = feature_cols,
    sample = selected,
    operation = "correlation_threshold"
  ) %>%
  dplyr::collect()
feature_cols <-
  colnames(selected) %>%
  stringr::str_subset("^Nuclei_|^Cells_|^Cytoplasm_")
```

```{r}

normalized <-
  cytominr::normalize(
    population = selected,
    variables = feature_cols,
    strata =  c("Metadata_Plate"),
    sample = selected %>% dplyr::filter(Metadata_broad_sample == "control")
  )
```


```{r}

grouping_cols <- c("Metadata_Plate", "Metadata_Well")
feature_col <- "Cells_Intensity_MeanIntensity_DNA"

#f_rep_cor <- function(df, feature_cols) {
  

f_rep_cor_1 <- function(df1) {
 cmat <- 
 df1 %>%
   arrange_(.dots = grouping_cols) %>% 
   select_(.dots = c(grouping_cols, feature_col)) %>% 
   tidyr::spread_("Metadata_Plate", feature_col) %>% 
   dplyr::select(-Metadata_Well) %>%
   cor()

 median(cmat[upper.tri(cmat)])
}

df <- selected %>% 
    filter(Metadata_broad_sample == "trt")

df %>%
  split(.$Metadata_Compound_Plate_Map_Name) %>%
  purrr::map_df(f_rep_cor_1)
  
  # sapply(feature_cols, function () {
  # }
  
#}


selected %>% 
      filter(Metadata_broad_sample == "trt")
  
```

